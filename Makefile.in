#
# makefile for savelogs
#
LEX	= @LEX@ -li
YACC	= @YACC@
CC	= @CC@
CFLAGS	= @CFLAGS@
MANDIR  = @mandir@
CONFDIR = @confdir@
LIBDIR  = @libdir@
SBINDIR  =@prefix@/sbin

OBJECTS	= savelogs.o lex.yy.o y.tab.o version.o

target: savelogs

savelogs: $(OBJECTS) y.tab.h config.h savelogs.h
	$(CC) $(CFLAGS) -o savelogs $(OBJECTS)

lex.yy.o: scan.l y.tab.h config.h savelogs.h
	$(LEX) scan.l
	$(CC) $(CFLAGS) -c lex.yy.c

y.tab.c y.tab.h: gram.y config.h savelogs.h
	$(YACC) -d gram.y

version.o: VERSION config.h
	@echo "char version[] = VERSION;" > version.c
	$(CC) $(CFLAGS) -c version.c -DVERSION=\"`cat VERSION`\"
	@rm -f version.c

savelogs.o: savelogs.c y.tab.h config.h

clean: untest
	rm -f savelogs *.o lex.yy.? version.c y.tab.?

untest:
	rm -f DEMO? demo.conf
	rm -rf OLD

distclean spotless: clean
	rm -f config.* Makefile savelogs.8

preptest: untest
	-mkdir OLD
	for file in DEMO1 DEMO2 DEMO3 DEMO4 DEMO5; do \
	    dd if=/dev/zero of=$$file count=201 bs=1024 >/dev/null; \
	done

demo.conf: preptest
	@SED@ -e "s~@HERE@~`pwd`~g" < demo.conf.sh > demo.conf

test demo: savelogs preptest demo.conf
	./savelogs -ddd -C demo.conf
	@echo -n "test DEMO1..."; test ! -r DEMO1 && echo "ok" || echo "failed"
	@echo -n "test DEMO2..."; test   -r DEMO2 && echo "ok" || echo "failed"
	@echo -n "test DEMO3..."; test ! -s DEMO3 && echo "ok" || echo "failed"
	@echo -n "test DEMO4..."; test ! -r DEMO4 && echo "ok" || echo "failed"

install: install.man install.bin 

install.man:
	@INSTALL@ -d $(DEST)$(MANDIR)/man8
	@INSTALL_DATA@ savelogs.8 $(DEST)$(MANDIR)/man8

install.bin:
	@INSTALL@ -d $(DEST)$(SBINDIR)
	@INSTALL_PROGRAM@ savelogs $(DEST)$(SBINDIR)

install.conf:
	if [ ! -r $(DEST)$(CONFDIR)/savelogs.conf ]; then \
	    @INSTALL@ -d $(DEST)$(CONFDIR); \
	    @INSTALL_DATA@ log.conf $(DEST)$(CONFDIR)/savelogs.conf; \
	fi
